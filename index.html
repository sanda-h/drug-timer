<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŠè–¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ï¼ˆå†™çœŸä»˜ãï¼‹ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/590/590685.png">
  <style>
    :root {
      --bg-color: #f9f9f9;
      --text-color: #333;
      --primary-color: #1976d2;
      --secondary-bg: #e3f2fd;
      --table-bg: #fff;
      --border-color: #ccc;
    }
    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #e0e0e0;
      --primary-color: #90caf9;
      --secondary-bg: #2c2c2c;
      --table-bg: #2a2a2a;
      --border-color: #555;
    }
    body {
      font-family: 'Segoe UI', 'Yu Gothic', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 30px 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-bottom: 15px;
      font-size: 18px;
    }
    input[type="text"], input[type="time"], input[type="file"] {
      width: 100%;
      max-width: 300px;
      padding: 10px;
      font-size: 16px;
      margin-top: 5px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: #fff;
      color: #000;
    }
    .weekday-label {
      display: inline-block;
      background-color: var(--secondary-bg);
      border-radius: 20px;
      padding: 6px 12px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .weekday-label input[type="checkbox"] {
      margin-right: 6px;
      transform: scale(1.2);
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 5px;
    }
    button:hover {
      background-color: #1565c0;
    }
    #themeToggle {
      float: right;
      margin-bottom: 20px;
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: var(--table-bg);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      padding: 14px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
      font-size: 16px;
    }
    th {
      background-color: var(--secondary-bg);
      color: var(--primary-color);
    }
    td img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }
    @media (max-width: 600px) {
      input[type="text"], input[type="time"], input[type="file"] {
        max-width: 100%;
      }
      button {
        width: 100%;
        margin-bottom: 10px;
      }
      td, th {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <button id="themeToggle" onclick="toggleTheme()">ğŸŒ— ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
  <h1>ğŸ’Š ãŠè–¬ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h1>
  <div>
    <label>è–¬ã®åå‰:
      <input type="text" id="medicineName" placeholder="ä¾‹ï¼šãƒ“ã‚¿ãƒŸãƒ³å‰¤" />
    </label>
    <label>é€šçŸ¥æ™‚é–“:
      <input type="time" id="medicineTime" />
    </label>
    <label>è–¬ã®å†™çœŸ:
      <input type="file" id="medicineImage" accept="image/*" capture="environment">
    </label>
    <div>
      <span style="font-weight: bold;">æ›œæ—¥é¸æŠ:</span><br>
      <label class="weekday-label"><input type="checkbox" value="æ—¥">æ—¥</label>
      <label class="weekday-label"><input type="checkbox" value="æœˆ">æœˆ</label>
      <label class="weekday-label"><input type="checkbox" value="ç«">ç«</label>
      <label class="weekday-label"><input type="checkbox" value="æ°´">æ°´</label>
      <label class="weekday-label"><input type="checkbox" value="æœ¨">æœ¨</label>
      <label class="weekday-label"><input type="checkbox" value="é‡‘">é‡‘</label>
      <label class="weekday-label"><input type="checkbox" value="åœŸ">åœŸ</label>
    </div>
    <button onclick="addOrUpdateMedicine()">â• è¿½åŠ ã™ã‚‹</button>
    <button onclick="backupData()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
    <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreData(event)">
    <button onclick="document.getElementById('restoreFile').click()">ğŸ“‚ å¾©å…ƒ</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>è–¬</th>
        <th>æ™‚é–“</th>
        <th>æ›œæ—¥</th>
        <th>æœç”¨</th>
        <th>ç”»åƒ</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="medicineTableBody"></tbody>
  </table>

  <script>
    const STORAGE_KEY = "medicines";
    let medicines = [];
    let editIndex = -1;

    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 86400000).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }
    function getCookie(name) {
      const cookies = document.cookie.split("; ");
      for (const c of cookies) {
        const [key, val] = c.split("=");
        if (key === name) return decodeURIComponent(val);
      }
      return null;
    }
    function loadData() {
      const saved = getCookie(STORAGE_KEY);
      if (saved) {
        try {
          medicines = JSON.parse(saved);
        } catch {
          medicines = [];
        }
      }
    }
    function saveData() {
      setCookie(STORAGE_KEY, JSON.stringify(medicines), 365);
    }
    function saveAndRender() {
      saveData();
      renderTable();
    }
    function renderTable() {
      const tbody = document.getElementById("medicineTableBody");
      tbody.innerHTML = "";
      medicines.forEach((med, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${med.name}</td>
          <td>${med.time}</td>
          <td>${med.days.join(",")}</td>
          <td><input type="checkbox" ${med.checked ? "checked" : ""} onchange="toggleCheck(${i}, this.checked)"></td>
          <td>${med.image ? `<img src="${med.image}">` : "ãªã—"}</td>
          <td>
            <button onclick="editMedicine(${i})">ç·¨é›†</button>
            <button onclick="deleteMedicine(${i})">å‰Šé™¤</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function getSelectedDays() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    function setSelectedDays(days) {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = days.includes(cb.value);
      });
    }
    function clearInputs() {
      document.getElementById("medicineName").value = "";
      document.getElementById("medicineTime").value = "";
      document.getElementById("medicineImage").value = "";
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      editIndex = -1;
    }

    function toggleCheck(index, checked) {
      medicines[index].checked = checked;
      saveData();
    }

    function addOrUpdateMedicine() {
  const name = document.getElementById("medicineName").value.trim();
  const time = document.getElementById("medicineTime").value;
  const days = getSelectedDays();
  const file = document.getElementById("medicineImage").files[0];

  if (!name || !time || days.length === 0) {
    alert("è–¬ã®åå‰ãƒ»æ™‚é–“ãƒ»æ›œæ—¥ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const processEntry = (imageDataUrl = null) => {
    const newEntry = {
      name,
      time,
      days,
      checked: false,
      image: imageDataUrl,
      confirmed: false,
      notifiedAt: null,
    };
    if (editIndex >= 0) {
      medicines[editIndex] = newEntry;
    } else {
      medicines.push(newEntry);
    }
    clearInputs();
    saveAndRender();
  };

  if (file) {
    const reader = new FileReader();
    reader.onload = () => processEntry(reader.result);
    reader.readAsDataURL(file);
  } else {
    processEntry(null); // ç”»åƒãªã—ã§ã‚‚ç™»éŒ²å¯èƒ½ã«
  }
}


    function editMedicine(index) {
      const med = medicines[index];
      document.getElementById("medicineName").value = med.name;
      document.getElementById("medicineTime").value = med.time;
      setSelectedDays(med.days);
      editIndex = index;
    }

    function deleteMedicine(index) {
      medicines.splice(index, 1);
      saveAndRender();
    }

    function requestPermission() {
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }
    }

    function startNotificationChecker() {
      setInterval(() => {
        const now = new Date();
        const nowStr = now.toTimeString().slice(0, 5);
        const today = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][now.getDay()];
        medicines.forEach(med => {
          if (med.time === nowStr && med.days.includes(today) && !med.checked) {
            new Notification("ğŸ’Š ãŠè–¬ã®æ™‚é–“ã§ã™ï¼", {
              body: `${med.name}ã‚’é£²ã‚€æ™‚é–“ã§ã™`,
              icon: med.image || "https://cdn-icons-png.flaticon.com/512/590/590685.png"
            });
          }
        });
      }, 60000);
    }

    function toggleTheme() {
      const body = document.body;
      body.classList.toggle("dark");
      localStorage.setItem("theme", body.classList.contains("dark") ? "dark" : "light");
    }

    function loadTheme() {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") {
        document.body.classList.add("dark");
      }
    }

    function backupData() {
      const blob = new Blob([JSON.stringify(medicines, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "medicines_backup.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            medicines = data;
            saveData();
            renderTable();
            alert("å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
          } else {
            alert("ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚");
          }
        } catch {
          alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      };
      reader.readAsText(file);
    }

    function resetWeeklyChecks() {
      const lastReset = getCookie("lastResetDate");
      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);
      if (today.getDay() === 0 && lastReset !== todayStr) {
        medicines.forEach(m => m.checked = false);
        setCookie("lastResetDate", todayStr, 7);
        saveAndRender();
      }
    }

    function init() {
      loadTheme();
      loadData();
      renderTable();
      requestPermission();
      startNotificationChecker();
      resetWeeklyChecks();
    }
    init();


function startNotificationChecker() {
  setInterval(() => {
    const now = new Date();
    const nowStr = now.toTimeString().slice(0, 5);
    const today = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][now.getDay()];

    medicines.forEach((med, i) => {
      if (!med.confirmed && med.days.includes(today)) {
        // åˆå› or å†é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°
        const shouldNotify =
          (med.time === nowStr && !med.notifiedAt) ||
          (med.notifiedAt && Math.floor((Date.now() - med.notifiedAt) / 60000) >= 1);

        if (shouldNotify) {
          new Notification("ğŸ’Š ãŠè–¬ã®æ™‚é–“ã§ã™ï¼", {
            body: `${med.name}ã‚’é£²ã‚“ã ã‚‰å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„`,
            icon: med.image || "https://cdn-icons-png.flaticon.com/512/590/590685.png"
          });
          medicines[i].notifiedAt = Date.now();
          saveData();
        }
      }
    });
  }, 60000);
}

// å†™çœŸç¢ºèªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
function confirmIntake(index, imageFile) {
  const reader = new FileReader();
  reader.onload = () => {
    medicines[index].confirmationImage = reader.result;
    medicines[index].confirmed = true;
    medicines[index].confirmedAt = Date.now();  // â† ã“ã“ã‚’è¿½åŠ 
    medicines[index].notifiedAt = null;
    saveAndRender();
    alert("æœç”¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚");
  };
  reader.readAsDataURL(imageFile);
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»å¤‰æ›´
function renderTable() {
  const tbody = document.getElementById("medicineTableBody");
  tbody.innerHTML = "";
  medicines.forEach((med, i) => {
    const confirmButton = med.confirmed
      ? "âœ… æ¸ˆ"
      : `<input type="file" accept="image/*" onchange="confirmIntake(${i}, this.files[0])">`;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${med.name}</td>
      <td>${med.time}</td>
      <td>${med.days.join(",")}</td>
      <td><input type="checkbox" ${med.checked ? "checked" : ""} onchange="toggleCheck(${i}, this.checked)"></td>
      <td>${med.image ? `<img src="${med.image}">` : "ãªã—"}</td>
      <td>
        ${confirmButton}<br>
        <button onclick="editMedicine(${i})">ç·¨é›†</button>
        <button onclick="deleteMedicine(${i})">å‰Šé™¤</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}



function resetOldConfirmations() {
  const now = Date.now();
  const SIX_DAYS_MS = 6 * 24 * 60 * 60 * 1000;

  medicines.forEach(med => {
    if (med.confirmed && med.confirmedAt && (now - med.confirmedAt > SIX_DAYS_MS)) {
      med.confirmed = false;
      med.confirmationImage = null;
      med.confirmedAt = null;
    }
  });

  saveAndRender();
}






  </script>
</body>
</html>
